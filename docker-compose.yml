version: '3.8'

services:
  mongodb:
    image: mongo:6.0
    container_name: airbnb-mongodb
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: airbnb_rw_user
      MONGO_INITDB_ROOT_PASSWORD: Pass123
      MONGO_INITDB_DATABASE: AirBnB
    volumes:
      - mongodb_data:/data/db
    networks:
      - airbnb-network
    healthcheck:
      test: ["CMD", "mongosh", "--username", "airbnb_rw_user", "--password", "Pass123", "--authenticationDatabase", "admin", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  api:
    build: ./api
    container_name: airbnb-api
    ports:
      - "4000:4000"
    environment:
      PORT: 4000
      DB_URL: mongodb://airbnb_rw_user:Pass123@mongodb:27017/AirBnB?authSource=admin
      JWT_SECRET: 8d0045dd1189f0569770d5fb9019d76c979f7e6f29650a5a76990d7f603934d8a12de140467132c4398ecc2ed77e03c5ee53a8469902821c642aa429c6508a64
      JWT_EXPIRY: 20d
      COOKIE_TIME: 7
      SESSION_SECRET: 0b2c720f05ef6137db23808975ba4c3db8a94bd381b3484224eca8aa08f687ec1f11639708084abdd061d85cd60a9296af0b5e4361b24a4e8135345a69359ccf
      CLOUDINARY_NAME: dbbxzhomi
      CLOUDINARY_API_KEY: 723641648556277
      CLOUDINARY_API_SECRET: x6A1XgZ2T5w_jFoiZa4c4jNBJD4
      CLIENT_URL: http://localhost:5173
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - airbnb-network
    restart: on-failure

  client:
    build: ./client
    container_name: airbnb-client
    ports:
      - "5173:5173"
    environment:
      VITE_API_URL: http://localhost:4000
    depends_on:
      - api
    networks:
      - airbnb-network

volumes:
  mongodb_data:

networks:
  airbnb-network:
    driver: bridge
